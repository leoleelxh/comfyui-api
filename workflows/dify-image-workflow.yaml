app:
  description: 'ComfyUI图片生成服务'
  icon: 🖼️
  icon_background: '#FEF7C3'
  mode: chat
  name: ComfyUI Image Generator
  use_icon_as_answer_icon: false
kind: app
version: 0.1.0
workflow:
  conversation_variables:
    - description: '生成图片的提示词'
      name: prompt
      value: ''
      value_type: string
  environment_variables:
    - name: comfyui_api_url
      value: 'http://localhost:8888'
      type: string
      description: 'ComfyUI API地址'
    - name: workflow_name
      value: 'workflow-api'
      type: string
      description: 'ComfyUI工作流名称'
    - name: node_id
      value: '4'
      type: string
      description: 'ComfyUI工作流节点ID'
    - name: lsky_upload_url
      value: 'http://your-lsky-url/api/v1/upload'
      type: string
      description: '图床上传API地址'
    - name: lsky_token
      value: 'Bearer your-token'
      type: string
      description: '图床API认证Token'
  features:
    opening_statement: '欢迎使用ComfyUI图片生成服务！请输入您想要生成的图片描述。'
    suggested_questions_after_answer:
      enabled: true
    sensitive_word_avoidance:
      enabled: false
    speech_to_text:
      enabled: false
    retriever_resource:
      enabled: false
  graph:
    nodes:
      - id: 'start'
        type: start
        data:
          type: start
          title: Start
          variables:
            - type: text-input
              required: true
              label: '图片描述'
              variable: prompt
      - id: 'generate_image'
        type: http_request
        data:
          type: http_request
          title: Generate Image
          config:
            url: "{{vars.comfyui_api_url}}/api/workflow/{{vars.workflow_name}}"
            method: POST
            headers:
              Content-Type: "application/json"
            body:
              "{{vars.node_id}}":
                inputs:
                  text: "{{input.prompt}}"
            timeout: 60
      - id: 'check_status'
        type: http_request
        data:
          type: http_request
          title: Check Status
          config:
            url: "{{vars.comfyui_api_url}}/api/task_status/{{generate_image.data.prompt_id}}"
            method: GET
            timeout: 30
            retry:
              max_attempts: 20
              interval: 5
            success_conditions:
              - "{{response.status}} == 'completed'"
      - id: 'get_image'
        type: http_request
        data:
          type: http_request
          title: Get Image
          config:
            url: "{{vars.comfyui_api_url}}/api/history/{{generate_image.data.prompt_id}}/image"
            method: GET
            timeout: 30
      - id: 'upload_to_host'
        type: http_request
        data:
          type: http_request
          title: Upload to Host
          config:
            url: "{{vars.lsky_upload_url}}"
            method: POST
            headers:
              Authorization: "{{vars.lsky_token}}"
            body:
              file: "{{get_image.data}}"
            timeout: 120
      - id: 'format_response'
        type: answer
        data:
          type: answer
          title: Format Response
          answer: |
            图片生成并上传成功！
            访问地址：{{upload_to_host.data.data.links.url}}
            
            生成参数：
            - Prompt: {{input.prompt}}
            - 任务ID: {{generate_image.data.prompt_id}}
    edges:
      - source: 'start'
        target: 'generate_image'
        type: custom
      - source: 'generate_image'
        target: 'check_status'
        type: custom
      - source: 'check_status'
        target: 'get_image'
        type: custom
      - source: 'get_image'
        target: 'upload_to_host'
        type: custom
      - source: 'upload_to_host'
        target: 'format_response'
        type: custom
