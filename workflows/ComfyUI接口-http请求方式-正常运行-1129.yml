app:
  description: ComfyUI接口-http请求方式
  icon: 🤖
  icon_background: '#FFEAD5'
  mode: workflow
  name: ComfyUI接口-http请求方式
  use_icon_as_answer_icon: false
kind: app
version: 0.1.3
workflow:
  conversation_variables: []
  environment_variables:
  - description: ''
    id: 05ad2637-dedf-4d7a-b028-08509446b1d5
    name: lsky_upload_url
    selector: []
    value: http://192.168.1.32:2222/api/v1/upload
    value_type: string
  - description: ''
    id: c92e461f-658d-47d7-9a15-766ff1a50eb3
    name: lsky_token
    selector: []
    value: Bearer 1|DjFFUohzJ69WgWrn0eK4hy9wio4g0y89zwqlZ9tb
    value_type: string
  - description: ''
    id: a647c0f5-3d06-43bf-9db9-6d75ff600beb
    name: comfyui_base_url
    selector: []
    value: http://192.168.1.100:5000
    value_type: string
  features:
    file_upload:
      allowed_file_extensions:
      - .JPG
      - .JPEG
      - .PNG
      - .GIF
      - .WEBP
      - .SVG
      allowed_file_types:
      - image
      allowed_file_upload_methods:
      - local_file
      - remote_url
      enabled: false
      fileUploadConfig:
        audio_file_size_limit: 50
        batch_count_limit: 5
        file_size_limit: 15
        image_file_size_limit: 10
        video_file_size_limit: 100
        workflow_file_upload_limit: 10
      image:
        enabled: false
        number_limits: 3
        transfer_methods:
        - local_file
        - remote_url
      number_limits: 3
    opening_statement: ''
    retriever_resource:
      enabled: true
    sensitive_word_avoidance:
      enabled: false
    speech_to_text:
      enabled: false
    suggested_questions: []
    suggested_questions_after_answer:
      enabled: false
    text_to_speech:
      enabled: false
      language: ''
      voice: ''
  graph:
    edges:
    - data:
        isInIteration: false
        sourceType: start
        targetType: http-request
      id: 1732888514481-source-1732888520762-target
      source: '1732888514481'
      sourceHandle: source
      target: '1732888520762'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        sourceType: http-request
        targetType: code
      id: 1732888520762-source-1732889284276-target
      source: '1732888520762'
      sourceHandle: source
      target: '1732889284276'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        sourceType: code
        targetType: code
      id: 1732889284276-source-1732890457522-target
      source: '1732889284276'
      sourceHandle: source
      target: '1732890457522'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        sourceType: code
        targetType: code
      id: 1732890457522-source-17328908333740-target
      source: '1732890457522'
      sourceHandle: source
      target: '17328908333740'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        sourceType: code
        targetType: code
      id: 17328908333740-source-17328908494420-target
      source: '17328908333740'
      sourceHandle: source
      target: '17328908494420'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        sourceType: code
        targetType: http-request
      id: 17328908494420-source-17328892044960-target
      source: '17328908494420'
      sourceHandle: source
      target: '17328892044960'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        sourceType: http-request
        targetType: code
      id: 17328892044960-source-1732892790708-target
      source: '17328892044960'
      sourceHandle: source
      target: '1732892790708'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        sourceType: code
        targetType: end
      id: 1732892790708-source-1732888864527-target
      source: '1732892790708'
      sourceHandle: source
      target: '1732888864527'
      targetHandle: target
      type: custom
      zIndex: 0
    nodes:
    - data:
        desc: ''
        selected: false
        title: 开始
        type: start
        variables:
        - label: workflow
          max_length: 48
          options: []
          required: true
          type: text-input
          variable: workflow
        - label: nodeid
          max_length: 48
          options: []
          required: true
          type: text-input
          variable: nodeid
        - label: prompt
          max_length: 999999
          options: []
          required: true
          type: paragraph
          variable: prompt
        - label: time
          max_length: 48
          options: []
          required: true
          type: text-input
          variable: time
      height: 168
      id: '1732888514481'
      position:
        x: 244
        y: 318.3344190302051
      positionAbsolute:
        x: 244
        y: 318.3344190302051
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        authorization:
          config: null
          type: no-auth
        body:
          data:
          - id: key-value-14
            key: ''
            type: text
            value: '{"{{#1732888514481.nodeid#}}": {"inputs": {"text": "{{#1732888514481.prompt#}}"}}}'
          type: json
        desc: ''
        headers: ''
        method: post
        params: ''
        selected: false
        timeout:
          max_connect_timeout: 0
          max_read_timeout: 0
          max_write_timeout: 0
        title: 发起ComfyUI任务
        type: http-request
        url: '{{#env.comfyui_base_url#}}/api/workflow/{{#1732888514481.workflow#}}'
        variables: []
      height: 115
      id: '1732888520762'
      position:
        x: 603.7833926585297
        y: 318.3344190302051
      positionAbsolute:
        x: 603.7833926585297
        y: 318.3344190302051
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        desc: ''
        outputs:
        - value_selector:
          - '1732892790708'
          - result
          variable: body
        selected: false
        title: 结束
        type: end
      height: 90
      id: '1732888864527'
      position:
        x: 1848.1887245721807
        y: 359.6875598100983
      positionAbsolute:
        x: 1848.1887245721807
        y: 359.6875598100983
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        authorization:
          config: null
          type: no-auth
        body:
          data: []
          type: none
        desc: ''
        headers: ''
        method: get
        params: ''
        selected: false
        timeout:
          connect: 300
          max_connect_timeout: 0
          max_read_timeout: 0
          max_write_timeout: 0
          read: 300
        title: 获取ComfyUI图片
        type: http-request
        url: '{{#env.comfyui_base_url#}}/api/image/{{#1732889284276.result#}}'
        variables: []
      height: 115
      id: '17328892044960'
      position:
        x: 1189.6959729970104
        y: 380.02532288341064
      positionAbsolute:
        x: 1189.6959729970104
        y: 380.02532288341064
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        code: "def main(arg1: str) -> dict:\n    import json\n    \n    # 解析JSON字符串\n\
          \    data = json.loads(arg1)\n    \n    # 提取prompt_id\n    prompt_id = data.get(\"\
          prompt_id\", \"\")\n    \n    return {\n        \"result\": prompt_id\n\
          \    }\n"
        code_language: python3
        desc: ''
        outputs:
          result:
            children: null
            type: string
        selected: false
        title: 提取prompt_id
        type: code
        variables:
        - value_selector:
          - '1732888520762'
          - body
          variable: arg1
      height: 54
      id: '1732889284276'
      position:
        x: 633.7735345832622
        y: 549.5845053226867
      positionAbsolute:
        x: 633.7735345832622
        y: 549.5845053226867
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        code: "def main(time: str) -> dict:\n    import time as time_module\n    \n\
          \    # 将输入的时间字符串转换为浮点数\n    wait_time = float(time)\n    \n    # 等待指定的秒数\n\
          \    time_module.sleep(wait_time)\n    \n    return {\n        \"result\"\
          : f\"等待{wait_time}秒完成\"\n    }\n"
        code_language: python3
        desc: ''
        outputs:
          result:
            children: null
            type: string
        selected: false
        title: 等待10s
        type: code
        variables:
        - value_selector:
          - '1732888514481'
          - time
          variable: time
      height: 54
      id: '1732890457522'
      position:
        x: 633.7735345832622
        y: 724.189183210226
      positionAbsolute:
        x: 633.7735345832622
        y: 724.189183210226
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        code: "def main(time: str) -> dict:\n    import time as time_module\n    \n\
          \    # 将输入的时间字符串转换为浮点数\n    wait_time = float(time)\n    \n    # 等待指定的秒数\n\
          \    time_module.sleep(wait_time)\n    \n    return {\n        \"result\"\
          : f\"等待{wait_time}秒完成\"\n    }\n"
        code_language: python3
        desc: ''
        outputs:
          result:
            children: null
            type: string
        selected: false
        title: 等待10s
        type: code
        variables:
        - value_selector:
          - '1732888514481'
          - time
          variable: time
      height: 54
      id: '17328908333740'
      position:
        x: 902.5835668351835
        y: 724.189183210226
      positionAbsolute:
        x: 902.5835668351835
        y: 724.189183210226
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        code: "def main(time: str) -> dict:\n    import time as time_module\n    \n\
          \    # 将输入的时间字符串转换为浮点数\n    wait_time = float(time)\n    \n    # 等待指定的秒数\n\
          \    time_module.sleep(wait_time)\n    \n    return {\n        \"result\"\
          : f\"等待{wait_time}秒完成\"\n    }\n"
        code_language: python3
        desc: ''
        outputs:
          result:
            children: null
            type: string
        selected: false
        title: 等待10s
        type: code
        variables:
        - value_selector:
          - '1732888514481'
          - time
          variable: time
      height: 54
      id: '17328908494420'
      position:
        x: 1169.0194026070637
        y: 724.189183210226
      positionAbsolute:
        x: 1169.0194026070637
        y: 724.189183210226
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        author: leoleexh
        desc: ''
        height: 88
        selected: false
        showAuthor: true
        text: '{"root":{"children":[{"children":[{"detail":0,"format":0,"mode":"normal","style":"","text":"只能这样实现，延迟获取图片","type":"text","version":1}],"direction":"ltr","format":"","indent":0,"type":"paragraph","version":1,"textFormat":0}],"direction":"ltr","format":"","indent":0,"type":"root","version":1}}'
        theme: blue
        title: ''
        type: ''
        width: 240
      height: 88
      id: '1732892530357'
      position:
        x: 634.5436490974023
        y: 798.9214358044968
      positionAbsolute:
        x: 634.5436490974023
        y: 798.9214358044968
      sourcePosition: right
      targetPosition: left
      type: custom-note
      width: 240
    - data:
        code: "def main(comfyui_response: str,\n         lsky_upload_url: str,\n \
          \        lsky_token: str) -> dict:\n    \"\"\"\n    上传ComfyUI生成的图片到图床\n\
          \    \n    参数:\n        comfyui_response: ComfyUI返回的响应数据，格式如：\n        \
          \    {\n                \"images\": [\n                    {\n         \
          \               \"filename\": \"ComfyUI_06116_.png\",\n                \
          \        \"subfolder\": \"\",\n                        \"type\": \"temp\"\
          ,\n                        \"url\": \"http://192.168.1.196:8188/view?filename=ComfyUI_06116_.png&subfolder=&type=temp\"\
          \n                    }\n                ],\n                \"status\"\
          : \"success\"\n            }\n        lsky_upload_url: Lsky图床上传API地址，例如：https://pic.example.com/api/v1/upload\n\
          \        lsky_token: Lsky的API Token，支持两种格式：\n                   1. Bearer\
          \ your-token\n                   2. your-token （会自动添加Bearer前缀）\n    \n \
          \   返回:\n        dict: 包含结果的字典，格式为：{\"result\": \"结果字符串\"}\n    \"\"\"\n\
          \    import requests\n    import json\n    from io import BytesIO\n    from\
          \ requests.adapters import HTTPAdapter\n    from urllib3.util.retry import\
          \ Retry\n    from urllib.parse import urlparse, parse_qs\n\n    # 设置重试策略\n\
          \    retry_strategy = Retry(\n        total=3,\n        backoff_factor=1,\n\
          \        status_forcelist=[429, 500, 502, 503, 504]\n    )\n    adapter\
          \ = HTTPAdapter(max_retries=retry_strategy)\n    session = requests.Session()\n\
          \    session.mount(\"http://\", adapter)\n    session.mount(\"https://\"\
          , adapter)\n\n    try:\n        # 将字符串转换为字典\n        try:\n            if\
          \ isinstance(comfyui_response, str):\n                comfyui_response =\
          \ json.loads(comfyui_response)\n        except json.JSONDecodeError:\n \
          \           return {\"result\": \"Error: Invalid JSON string in comfyui_response\"\
          }\n\n        # 1. 验证并获取图片信息\n        if not comfyui_response.get('status')\
          \ == 'success' or not comfyui_response.get('images'):\n            return\
          \ {\"result\": \"Error: Invalid response data or no images found\"}\n  \
          \      \n        image_info = comfyui_response['images'][0]\n        image_url\
          \ = image_info['url']\n        filename = image_info['filename']\n     \
          \   \n        # 处理URL，移除多余的参数\n        parsed_url = urlparse(image_url)\n\
          \        base_url = f\"{parsed_url.scheme}://{parsed_url.netloc}{parsed_url.path}\"\
          \n        query_params = parse_qs(parsed_url.query)\n        \n        if\
          \ 'filename' in query_params:\n            image_url = f\"{base_url}?filename={query_params['filename'][0]}\"\
          \n        \n        # 2. 下载图片\n        image_response = session.get(image_url,\
          \ verify=False, timeout=30)\n        if image_response.status_code != 200:\n\
          \            return {\"result\": f\"Error: Failed to download image (Status\
          \ {image_response.status_code})\"}\n        \n        image_data = image_response.content\n\
          \        \n        # 3. 上传到图床\n        # 处理token格式\n        if not lsky_token.startswith('Bearer\
          \ '):\n            lsky_token = f'Bearer {lsky_token}'\n            \n \
          \       headers = {\n            \"Authorization\": lsky_token\n       \
          \ }\n        \n        files = {\n            'file': (filename, BytesIO(image_data),\
          \ 'image/png')\n        }\n        \n        upload_response = session.post(\n\
          \            lsky_upload_url,\n            headers=headers,\n          \
          \  files=files,\n            verify=False,\n            timeout=30\n   \
          \     )\n        \n        upload_result = upload_response.json()\n    \
          \    \n        if not upload_result.get('status'):\n            return {\"\
          result\": f\"Error: Upload failed - {upload_result.get('message', 'Unknown\
          \ error')}\"}\n        \n        # 返回markdown格式的图片链接\n        image_url\
          \ = upload_result.get('data', {}).get('links', {}).get('url')\n        if\
          \ not image_url:\n            return {\"result\": \"Error: No image URL\
          \ in upload response\"}\n            \n        return {\"result\": f\"![Generated\
          \ Image]({image_url})\"}\n        \n    except Exception as e:\n       \
          \ return {\"result\": f\"Error: {str(e)}\"}\n"
        code_language: python3
        desc: ''
        outputs:
          result:
            children: null
            type: string
        selected: false
        title: 解析并上传到图床
        type: code
        variables:
        - value_selector:
          - '17328892044960'
          - body
          variable: comfyui_response
        - value_selector:
          - env
          - lsky_upload_url
          variable: lsky_upload_url
        - value_selector:
          - env
          - lsky_token
          variable: lsky_token
      height: 54
      id: '1732892790708'
      position:
        x: 1542.6066990386853
        y: 365.7504260761399
      positionAbsolute:
        x: 1542.6066990386853
        y: 365.7504260761399
      selected: true
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    viewport:
      x: 108.16019610572312
      y: 132.50578171959796
      zoom: 0.6597539553864478
